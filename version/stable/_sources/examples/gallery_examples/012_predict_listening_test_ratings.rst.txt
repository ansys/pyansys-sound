
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples\gallery_examples\012_predict_listening_test_ratings.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_gallery_examples_012_predict_listening_test_ratings.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_gallery_examples_012_predict_listening_test_ratings.py:


.. _predict_listening_test_ratings:

Predict listening test ratings
------------------------------

This example shows how to predict the mean ratings of automotive HVAC sounds based on
psychoacoustic indicators, using the data from a listening test conducted with Ansys Sound - Jury
Listening Test (JLT).

Here, we demonstrate how to build an objective indicator to help predict automotive HVAC sound
ratings, on the basis of 4 psychoacoustic indicators that are typically used for such sounds:

- Loudness (ISO 532-1),
- Sharpness (DIN 45692),
- Fluctuation strength (Sontacchi method),
- Tonality (ECMA 418-2).

The sound ratings used in this example were obtained from a listening test designed with Ansys
Sound JLT. In this test, 29 participants evaluated 20 automotive HVAC sounds. This example uses the
data obtained when exporting, in JLT, the analyzed results to a CSV file. With a standard
installation of JLT, the corresponding listening test project should be located here:
`C:/Users/Public/Documents/Ansys/Acoustics/JLT/CE - Automotive HVAC`.

.. GENERATED FROM PYTHON SOURCE LINES 49-53

Set up analysis
~~~~~~~~~~~~~~~
Setting up the analysis consists of loading Ansys libraries, connecting to the DPF server, and
downloading the necessary data files.

.. GENERATED FROM PYTHON SOURCE LINES 53-86

.. code-block:: Python


    # Load standard libraries.
    from math import sqrt
    import os

    from ansys.dpf.core import Field
    import matplotlib.pyplot as plt
    from sklearn import linear_model

    # Load Ansys libraries.
    from ansys.sound.core.examples_helpers import (
        download_all_carHVAC_wav,
        download_HVAC_test_wav,
        download_JLT_CE_data_csv,
    )
    from ansys.sound.core.psychoacoustics import (
        FluctuationStrength,
        LoudnessISO532_1_Stationary,
        SharpnessDIN45692,
        TonalityECMA418_2,
    )
    from ansys.sound.core.server_helpers import connect_to_or_start_server
    from ansys.sound.core.signal_utilities import LoadWav
    from ansys.sound.core.signal_utilities.crop_signal import CropSignal

    # Connect to a remote DPF server or start a local DPF server.
    my_server, my_license_context = connect_to_or_start_server(use_license_context=True)

    # Download the necessary files for this example.
    model_wav_files_path = download_all_carHVAC_wav()
    JLT_ratings_path = download_JLT_CE_data_csv()
    test_wav_file_path = download_HVAC_test_wav()








.. GENERATED FROM PYTHON SOURCE LINES 87-91

Define indicator computation function
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here we define a function that calculates the 4 psychoacoustic indicators of interest (listed at
the beginning of the example), given an input sound signal as a DPF field.

.. GENERATED FROM PYTHON SOURCE LINES 91-130

.. code-block:: Python



    def compute_indicators(signal: Field) -> list:
        """Compute psychoacoustic indicators for a given sound signal.

        Parameters
        ----------
        signal : Field
            Sound signal to analyze.

        Returns
        -------
        list
            List of psychoacoustic indicator values: loudness level in phon, sharpness in acum,
            fluctuation strength in vacil, and tonality in tuHMS.
        """
        # Loudness level (ISO 532-1)
        indicator = LoudnessISO532_1_Stationary(signal=signal)
        indicator.process()
        LN = indicator.get_loudness_level_phon()

        # Sharpness (DIN 45692)
        indicator = SharpnessDIN45692(signal=signal)
        indicator.process()
        S = indicator.get_sharpness()

        # Fluctuation strength (Sontacchi method)
        indicator = FluctuationStrength(signal=signal)
        indicator.process()
        FS = indicator.get_fluctuation_strength()

        # Tonality (ECMA 418-2)
        indicator = TonalityECMA418_2(signal=signal, field_type="Free", edition="3rd")
        indicator.process()
        T = indicator.get_tonality()

        return [LN, S, FS, T]









.. GENERATED FROM PYTHON SOURCE LINES 131-143

Define prediction function
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here we define a function that predicts the rating for an automotive HVAC sound signal, given a
set of regression coefficients. The function computes 4 relevant psychoacoustic indicators for
automotive HVAC sounds, and then applies the regression formula to obtain the predicted rating:

.. math::
       rating = a_0 + a_1 \cdot LN + a_2 \cdot S + a_3 \cdot FS + a_4 \cdot T

where :math:`a_0` is the intercept and :math:`a_1`, :math:`a_2`, :math:`a_3`, and :math:`a_4` are
the coefficients of the model, and :math:`LN`, :math:`S`, :math:`FS`, and :math:`T` are the
loudness level, sharpness, fluctuation strength, and tonality, respectively.

.. GENERATED FROM PYTHON SOURCE LINES 143-180

.. code-block:: Python



    def apply_prediction_formula(signal: Field, coefficients: list = None) -> float:
        """Apply the regression formula to predict the rating of a sound signal.

        Parameters
        ----------
        signal : Field
            Sound signal to evaluate.

        coefficients : list, default: None.
            List of regression coefficients (including the intercept): a0, a1, a2, a3, and a4. If None,
            the coefficients are [1, 0, 0, 0, 0].

        Returns
        -------
        float
            Predicted rating of the input sound signal.
        """
        if coefficients is None:
            coefficients = [1, 0, 0, 0, 0]
        elif not (isinstance(coefficients, list)) or len(coefficients) != 5:
            raise TypeError("coefficients must be a list of 5 elements.")

        # Compute the psychoacoustic indicators for the sound file.
        indicators = compute_indicators(signal)

        # Apply the formula to compute the rating.
        return (
            coefficients[0]
            + coefficients[1] * indicators[0]
            + coefficients[2] * indicators[1]
            + coefficients[3] * indicators[2]
            + coefficients[4] * indicators[3]
        )









.. GENERATED FROM PYTHON SOURCE LINES 181-186

Read the Ansys Sound JLT data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Read the CSV file produced with Ansys Sound JLT. This file contains descriptive statistics of the
sound ratings obtained during the listening test conduction. Most notably, it contains the
rating of each sound averaged over the test participants.

.. GENERATED FROM PYTHON SOURCE LINES 186-195

.. code-block:: Python


    # Initialize lists to store file names and ratings.
    filenames = []
    ratings = []

    # Print the file content for information.
    with open(JLT_ratings_path, encoding="utf-8-sig") as f:
        print(f.read())





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Test name ; Demo CE - Automotive HVAC
    Method ; Comparative Evaluation
    Low-range anchor ; carHVAC15
    High-range anchor ; carHVAC10

    Groups names;All participants; ; ; ;
    ;Mean;Median;Standard deviation;Standard error;95% confidence interval width
    carHVAC1;27.8966;23;21.2693;3.9496;15.4824
    carHVAC2;29.5862;29;15.3309;2.84688;11.1598
    carHVAC3;89.1034;91;11.6077;2.1555;8.44955
    carHVAC4;25.3793;17;24.6539;4.57812;17.9462
    carHVAC5;91.7586;96;9.89825;1.83806;7.20519
    carHVAC6;43.4483;42;19.0555;3.53852;13.871
    carHVAC7;35.4138;32;18.2552;3.3899;13.2884
    carHVAC8;84.7241;86;10.8328;2.0116;7.88548
    carHVAC9;53.8966;43;32.768;6.08486;23.8526
    carHVAC10;97.5287;99.3333;2.99274;0.555738;2.17849
    carHVAC11;12.2414;9;15.7427;2.92335;11.4595
    carHVAC12;56.8966;56;15.6304;2.9025;11.3778
    carHVAC13;48.1724;54;23.107;4.29086;16.8202
    carHVAC14;93.0345;93;7.34109;1.36321;5.34377
    carHVAC15;1.65517;0;3.69629;0.686384;2.69062
    carHVAC16;60.1724;67;15.1541;2.81405;11.0311
    carHVAC17;61;59;17.8666;3.31774;13.0055
    carHVAC18;93.7586;98;8.12692;1.50913;5.91579
    carHVAC19;3.37931;0;4.91654;0.912979;3.57888
    carHVAC20;9.7931;8;10.0441;1.86515;7.31137





.. GENERATED FROM PYTHON SOURCE LINES 196-197

Extract HVAC sound file names and mean ratings from the CSV file.

.. GENERATED FROM PYTHON SOURCE LINES 197-207

.. code-block:: Python

    with open(JLT_ratings_path, encoding="utf-8-sig") as f:
        lines = f.readlines()
        lines = lines[7:]  # Skip the first 7 lines (general info, and table header).

        # Store file names and mean ratings (first and second columns).
        for line in lines:
            row = line.split(";")
            filenames.append(row[0])
            ratings.append(float(row[1]))








.. GENERATED FROM PYTHON SOURCE LINES 208-223

Calculate the psychoacoustic indicators
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Compute the psychoacoustic indicators for each sound file. The following indicators are computed:

- Loudness (ISO 532-1),
- Sharpness (DIN 45692),
- Fluctuation strength (Sontacchi method),
- Tonality (ECMA 418-2).

.. note::
   This computation step may be long, as some indicators (fluctuation strength, and tonality) are
   quite heavy to compute. Note also that, although the sounds of the test are stereo (binaural
   recordings) and 5 seconds long, we are using the first second of the left channel only. You
   get similar results if you use the right channel or the average of the two, and the full
   signal duration.

.. GENERATED FROM PYTHON SOURCE LINES 223-248

.. code-block:: Python


    # Initialize a list to store the indicators for each file. The list will contain sublists, each
    # sublist containing the values of the selected indicators for each sound.
    indicators = []

    # Process each sound file one by one.
    for file_name in filenames:
        print(f"Calculating indicators for file: {file_name} ...")
        wav_file_path = os.path.join(model_wav_files_path, file_name + ".wav")

        # Load the sound file.
        wav_loader = LoadWav(wav_file_path)
        wav_loader.process()

        # Keep the first channel only.
        signal = wav_loader.get_output()[0]

        # Keep the first second of signal only.
        cropper = CropSignal(signal=signal, start_time=0.0, end_time=1.0)
        cropper.process()
        signal = cropper.get_output()

        # Compute and append the indicator values for the current sound to the list.
        indicators.append(compute_indicators(signal))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Calculating indicators for file: carHVAC1 ...
    Calculating indicators for file: carHVAC2 ...
    Calculating indicators for file: carHVAC3 ...
    Calculating indicators for file: carHVAC4 ...
    Calculating indicators for file: carHVAC5 ...
    Calculating indicators for file: carHVAC6 ...
    Calculating indicators for file: carHVAC7 ...
    Calculating indicators for file: carHVAC8 ...
    Calculating indicators for file: carHVAC9 ...
    Calculating indicators for file: carHVAC10 ...
    Calculating indicators for file: carHVAC11 ...
    Calculating indicators for file: carHVAC12 ...
    Calculating indicators for file: carHVAC13 ...
    Calculating indicators for file: carHVAC14 ...
    Calculating indicators for file: carHVAC15 ...
    Calculating indicators for file: carHVAC16 ...
    Calculating indicators for file: carHVAC17 ...
    Calculating indicators for file: carHVAC18 ...
    Calculating indicators for file: carHVAC19 ...
    Calculating indicators for file: carHVAC20 ...




.. GENERATED FROM PYTHON SOURCE LINES 249-253

Calculate the multiple linear regression
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Use package :mod:`sklearn` (https://scikit-learn.org/) to create a multiple linear
regression model, to predict the ratings based on the computed psychoacoustic indicators.

.. GENERATED FROM PYTHON SOURCE LINES 253-265

.. code-block:: Python


    # Create and compute the model.
    regression = linear_model.LinearRegression()
    regression.fit(indicators, ratings)

    # Compute the predicted ratings using the regression model.
    ratings_hat = regression.predict(indicators)

    # Display the model coefficients and the correlation coefficient.
    print(f"Linear regression model coefficients: {regression.coef_}")
    print(f"Correlation coefficient: {sqrt(regression.score(indicators, ratings)):.3f}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Linear regression model coefficients: [  1.78647762   9.1338461  202.52997427  56.17964625]
    Correlation coefficient: 0.983




.. GENERATED FROM PYTHON SOURCE LINES 266-267

Plot the predicted ratings against the actual ratings.

.. GENERATED FROM PYTHON SOURCE LINES 267-278

.. code-block:: Python


    plt.plot([0, 100], [0, 100], "k--")
    plt.scatter(ratings_hat, ratings)
    plt.xlabel("Predicted ratings")
    plt.ylabel("Actual ratings")
    plt.title("Predicted vs Actual ratings")
    plt.xlim(0, 100)
    plt.ylim(0, 100)
    plt.grid()
    plt.show()




.. image-sg:: /examples/gallery_examples/images/sphx_glr_012_predict_listening_test_ratings_001.png
   :alt: Predicted vs Actual ratings
   :srcset: /examples/gallery_examples/images/sphx_glr_012_predict_listening_test_ratings_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 279-282

The correlation coefficient (0.983) is very close to 1, and the points in the plot are
well aligned. This shows that the rating prediction model is quite accurate for the sounds of
the listening test.

.. GENERATED FROM PYTHON SOURCE LINES 284-299

Use the regression coefficients for prediction
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Use the model coefficients to estimate the rating of a new sound file. Using the model
coefficients consists of computing the indicators and applying the formula:

.. math::
       rating = a_0 + a_1 \cdot LN + a_2 \cdot S + a_3 \cdot FS + a_4 \cdot T

where :math:`a_0` is the intercept and :math:`a_1`, :math:`a_2`, :math:`a_3`, and :math:`a_4` are
the coefficients of the model, and :math:`LN`, :math:`S`, :math:`FS`, and :math:`T` are the
loudness level, sharpness, fluctuation strength, and tonality, respectively.

The coefficients of the model are stored in the regression object, and can be accessed using the
``coef_`` attribute. The intercept is stored in the ``intercept_`` attribute of the regression
object.

.. GENERATED FROM PYTHON SOURCE LINES 299-316

.. code-block:: Python


    # Load the sound file for which to predict the rating.
    wav_loader = LoadWav(test_wav_file_path)
    wav_loader.process()

    # Keep the first channel only.
    signal = wav_loader.get_output()[0]

    # Apply the regression formula to predict the rating of the sound file.
    # Note: the intercept (offset) must be added to the coefficients list.
    coefficients = [regression.intercept_] + list(regression.coef_)
    rating_hat = apply_prediction_formula(signal, coefficients)

    print(
        f"\nPredicted rating (0-100) for file {os.path.split(test_wav_file_path)[-1]}: {rating_hat:.2f}"
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Predicted rating (0-100) for file HVAC_test.wav: 28.52




.. GENERATED FROM PYTHON SOURCE LINES 317-320

This predicted rating (28.52) tells us that the sound is not very pleasant in comparison with the
other sounds of the listening test, and that it would have probably ranked poorly, had it been
included during the test conduction.


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (4 minutes 44.794 seconds)


.. _sphx_glr_download_examples_gallery_examples_012_predict_listening_test_ratings.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 012_predict_listening_test_ratings.ipynb <012_predict_listening_test_ratings.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 012_predict_listening_test_ratings.py <012_predict_listening_test_ratings.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 012_predict_listening_test_ratings.zip <012_predict_listening_test_ratings.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
